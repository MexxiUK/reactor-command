<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atomic Tycoon v1.1.3 - System Integrity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            background-color: #05070a;
            color: #d1d5db;
            font-family: 'JetBrains+Mono', monospace;
            user-select: none;
            overflow-x: hidden;
        }

        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 50;
        }

        .heat-bar-bg {
            background: #111827;
            border: 1px solid #374151;
            position: relative;
            overflow: hidden;
            height: 18px;
            display: flex;
        }

        .heat-zone-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background: rgba(255, 255, 255, 0.2);
            z-index: 10;
        }

        .heat-bar-fill {
            height: 100%;
            transition: width 0.05s linear;
            position: relative;
            z-index: 5;
        }

        .zone-tier-1 {
            background: #22c55e;
        }

        .zone-tier-2 {
            background: #84cc16;
        }

        .zone-tier-3 {
            background: #eab308;
        }

        .zone-tier-4 {
            background: #ef4444;
            animation: redline-flicker 0.1s infinite;
        }

        @keyframes redline-flicker {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }

            100% {
                opacity: 1;
            }
        }

        .building-card {
            background: rgba(31, 41, 55, 0.5);
            border: 1px solid #374151;
            transition: all 0.2s;
        }

        .building-card:hover:not(.disabled-milestone) {
            border-color: #10b981;
            background: rgba(31, 41, 55, 0.8);
        }

        .disabled-milestone {
            opacity: 0.4;
            cursor: not-allowed;
            grayscale: 100%;
        }

        .not-affordable {
            opacity: 0.5;
        }

        .scram-active {
            border-color: #ef4444 !important;
            animation: border-flicker 0.2s infinite;
        }

        @keyframes border-flicker {
            0% {
                border-color: #ef4444;
                box-shadow: inset 0 0 10px rgba(239, 68, 68, 0.2);
            }

            100% {
                border-color: #450a0a;
                box-shadow: inset 0 0 20px rgba(239, 68, 68, 0.4);
            }
        }

        .city-grid-item {
            width: 10px;
            height: 10px;
            border-radius: 1px;
            transition: all 0.4s ease;
        }

        .city-grid-dim {
            opacity: 0.1 !important;
            box-shadow: none !important;
        }

        .brownout-flicker {
            animation: flicker 0.5s infinite;
        }

        .shake-light {
            animation: shake 0.5s infinite;
        }

        .shake-heavy {
            animation: shake 0.2s infinite;
        }

        @keyframes shake {
            0% {
                transform: translate(1px, 1px) rotate(0deg);
            }

            10% {
                transform: translate(-1px, -2px) rotate(-1deg);
            }

            20% {
                transform: translate(-3px, 0px) rotate(1deg);
            }

            30% {
                transform: translate(3px, 2px) rotate(0deg);
            }

            40% {
                transform: translate(1px, -1px) rotate(1deg);
            }

            50% {
                transform: translate(-1px, 2px) rotate(-1deg);
            }

            100% {
                transform: translate(1px, 1px) rotate(0deg);
            }
        }

        select.manager-select {
            background-color: #111827;
            border: 1px solid #4b5563;
            color: #d1d5db;
            font-size: 9px;
            padding: 2px;
            border-radius: 2px;
            width: 100%;
            cursor: pointer;
            outline: none;
            text-transform: uppercase;
            font-weight: bold;
        }

        .master-ovr-btn {
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            touch-action: none;
        }

        .master-ovr-active {
            background-color: #7f1d1d !important;
            border-color: #ef4444 !important;
            color: #fee2e2 !important;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
            transform: scale(0.98);
            text-shadow: 0 0 5px #fff;
        }

        .icon-container {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #0f172a;
            color: #fff;
            text-align: center;
            border: 1px solid #3b82f6;
            padding: 12px;
            border-radius: 6px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 11px;
            line-height: 1.5;
            pointer-events: none;
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.7);
            text-transform: none;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .reactor-card-fixed {
            height: 250px;
        }

        .upgrade-tray-item {
            background: rgba(22, 28, 41, 0.8);
            border: 1px solid #4b5563;
            padding: 12px;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 80px;
            position: relative;
            overflow: hidden;
        }

        .upgrade-tray-item.affordable {
            border-color: #34d399;
            background: rgba(16, 185, 129, 0.1);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.1);
        }

        .upgrade-tray-item.affordable:hover {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            transform: translateY(-2px);
        }

        .upgrade-tray-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #374151;
        }

        .upgrade-tray-item.installed {
            border-color: #3b82f6;
            background: rgba(30, 58, 138, 0.3);
            cursor: default;
            opacity: 0.9;
        }

        .installed-badge {
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 7px;
            color: #60a5fa;
            background: rgba(30, 58, 138, 0.5);
            padding: 1px 4px;
            border-radius: 2px;
            font-weight: bold;
            text-transform: uppercase;
            border: 1px solid rgba(96, 165, 250, 0.3);
        }

        .upgrade-cost-text {
            font-size: 12px;
            font-weight: 700;
            margin-top: 6px;
        }

        .upgrade-title-text {
            font-size: 12px;
            font-weight: 800;
            letter-spacing: -0.01em;
        }

        .upgrade-desc-text {
            font-size: 10px;
            line-height: 1.3;
            margin-top: 4px;
        }

        #debug-panel {
            background: rgba(17, 24, 39, 0.98);
            border-top: 2px solid #ef4444;
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 1rem;
        }
    </style>
    <style>
        /* MODAL STYLES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        .modal-box {
            background: #111827;
            border: 1px solid #374151;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            border-radius: 8px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
            color: #ef4444;
            font-weight: bold;
        }

        textarea.save-string {
            width: 100%;
            height: 100px;
            background: #000;
            color: #10b981;
            font-family: monospace;
            font-size: 10px;
            padding: 0.5rem;
            border: 1px solid #374151;
            resize: none;
            margin: 1rem 0;
        }

        .contract-card {
            background: rgba(31, 41, 55, 0.4);
            border: 1px solid #4b5563;
            padding: 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 180px;
        }

        .contract-card:hover {
            border-color: #eab308;
            background: rgba(31, 41, 55, 0.8);
            transform: translateY(-2px);
        }

        .contract-d-easy {
            border-top: 2px solid #10b981;
        }

        .contract-d-med {
            border-top: 2px solid #eab308;
        }

        .contract-d-hard {
            border-top: 2px solid #ef4444;
        }

        @keyframes marquee {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        .animate-marquee {
            animation: marquee 10s linear infinite;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-40px) scale(1.2);
                opacity: 0;
            }
        }

        .floating-text {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            animation: floatUp 4s ease-out forwards;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-300 font-mono p-4 md:p-8 select-none overflow-x-hidden">
    <div class="scanline"></div>

    <!-- Help Button -->
    <a href="manual.html" target="_blank"
        class="fixed top-4 right-4 w-8 h-8 rounded-full border border-gray-600 bg-gray-900 text-gray-400 hover:text-emerald-400 hover:border-emerald-400 hover:shadow-[0_0_10px_rgba(52,211,153,0.5)] flex items-center justify-center font-bold transition-all z-50 text-sm"
        title="Operator Handbook">?</a>

    <div class="max-w-6xl mx-auto">
        <!-- HEADER STATS -->
        <header
            class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 bg-gray-900/80 p-6 rounded-lg border border-gray-700 relative">
            <div class="text-center md:text-left">
                <p class="text-[9px] uppercase text-gray-500 tracking-widest">Capital Reserve</p>
                <h2 class="text-3xl font-bold text-emerald-400">$<span id="cash-display">0</span></h2>
            </div>
            <div class="text-center">
                <p class="text-[9px] uppercase text-gray-500 tracking-widest">Net Revenue</p>
                <h2 class="text-2xl font-bold text-blue-400">$<span id="income-display">0</span><span
                        class="text-sm">/s</span></h2>
                <div id="efficiency-tag"
                    class="text-[8px] font-bold text-emerald-500 bg-emerald-950/30 px-2 py-0.5 rounded-full inline-block mt-1 uppercase tracking-widest">
                    Efficiency: 100%</div>
            </div>
            <div class="text-center">
                <div class="flex flex-col items-center">
                    <p class="text-[9px] uppercase text-gray-500 tracking-widest mb-1">Grid Market</p>
                    <div class="flex items-center gap-2">
                        <h2 class="text-2xl font-bold text-orange-400">$<span id="export-display">0</span><span
                                class="text-sm">/s</span></h2>
                        <div id="market-trend-arrow" class="text-xl font-bold text-gray-600">--</div>
                    </div>
                    <div class="text-[9px] uppercase tracking-tighter flex gap-3 mt-1">
                        <span class="text-gray-500">Price: <span id="market-price"
                                class="text-gray-300 font-bold">$0.10</span>/MW</span>
                    </div>
                    <!-- Sparkline Container -->
                    <div class="w-24 h-6 bg-gray-900/50 mt-1 border border-gray-800 relative overflow-hidden flex items-end gap-[1px]"
                        id="market-sparkline"></div>
                    <!-- News Ticker -->
                    <div class="w-48 overflow-hidden whitespace-nowrap mt-1 relative">
                        <div id="market-news"
                            class="text-[8px] text-gray-500 font-bold uppercase tracking-widest inline-block animate-marquee pl-48">
                            Initializing...</div>
                    </div>
                </div>
            </div>
            <div class="text-center md:text-right">
                <p class="text-[9px] uppercase text-gray-500 tracking-widest">Global Grid Load</p>
                <h2 class="text-2xl font-bold"><span id="power-used">0</span> / <span id="power-total">0</span> <span
                        class="text-sm text-gray-500">MW</span></h2>
                <div id="stability-indicator" class="text-[10px] uppercase text-emerald-500 font-bold tracking-widest">
                    System Stable</div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <!-- LEFT COLUMN -->
            <div class="lg:col-span-4 space-y-6">
                <h3
                    class="text-lg font-bold border-b border-gray-700 pb-2 flex items-center uppercase tracking-tighter">
                    <span class="mr-2">üèôÔ∏è</span> City Expansion
                </h3>

                <div id="build-list" class="space-y-3">
                    <div id="btn-house" onclick="buyBuilding('house')"
                        class="building-card p-3 rounded-md cursor-pointer flex items-center gap-4 transition-all">
                        <div class="icon-container text-emerald-500"><svg class="w-6 h-6" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            </svg></div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-emerald-400 text-[11px] uppercase">Housing</h4>
                                <span class="text-[11px] font-bold">$<span id="cost-house">100</span></span>
                            </div>
                            <p class="text-[9px] text-gray-500">1 MW | $2/s ‚Ä¢ <span id="count-house">0</span> Units</p>
                        </div>
                    </div>

                    <div id="btn-factory" onclick="buyBuilding('factory')"
                        class="building-card p-3 rounded-md cursor-pointer disabled-milestone flex items-center gap-4 transition-all">
                        <div class="icon-container text-blue-500"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path d="M2 20V4l7 5V4l7 5V4l6 4v12H2Z"></path>
                            </svg></div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-blue-400 text-[11px] uppercase tracking-tighter">Industrial
                                </h4>
                                <span class="text-[11px] font-bold">$<span id="cost-factory">25k</span></span>
                            </div>
                            <p class="text-[9px] text-gray-500" id="factory-desc">25 MW | $150/s ‚Ä¢ <span
                                    id="count-factory">0</span> Units</p>
                        </div>
                    </div>

                    <div id="btn-datacenter" onclick="buyBuilding('datacenter')"
                        class="building-card p-3 rounded-md cursor-pointer disabled-milestone flex items-center gap-4 transition-all">
                        <div class="icon-container text-purple-500"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <rect x="2" y="2" width="20" height="20" rx="2" />
                                <path d="M6 6h12M6 12h12M6 18h12" />
                            </svg></div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 id="dc-title-label"
                                        class="font-bold text-purple-400 text-[11px] uppercase tracking-tighter">Data
                                        Center</h4>
                                    <p class="text-[10px] text-gray-400"><span id="dc-demand-label">200</span> MW |
                                        $<span id="dc-revenue-label">2.5k</span>/s</p>
                                </div>
                                <span class="text-[11px] font-bold">$<span id="cost-datacenter">1.5M</span></span>
                            </div>
                            <p class="text-[9px] text-gray-500" id="datacenter-desc"><span
                                    id="count-datacenter">0</span> Units</p>
                        </div>
                    </div>

                    <div id="btn-skyscraper" onclick="buyBuilding('skyscraper')"
                        class="building-card p-3 rounded-md cursor-pointer disabled-milestone flex items-center gap-4 transition-all">
                        <div class="icon-container text-cyan-400"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path d="M3 21h18M5 21V3l14 0v18M9 7h1M9 11h1M9 15h1M14 7h1M14 11h1M14 15h1" />
                            </svg></div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-cyan-400 text-[11px] uppercase tracking-tighter">Commercial
                                    Hub</h4>
                                <span class="text-[11px] font-bold">$<span id="cost-skyscraper">50M</span></span>
                            </div>
                            <p class="text-[9px] text-gray-500" id="skyscraper-desc">1k MW | $25k/s ‚Ä¢ <span
                                    id="count-skyscraper">0</span> Units</p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900/50 p-4 border border-gray-800 rounded-md">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest">üõ°Ô∏è PERSONNEL</h4>
                        <span class="text-[10px] font-bold text-gray-600"><span id="manager-count">0</span>/4</span>
                    </div>
                    <div id="manager-slots" class="grid grid-cols-2 gap-2"></div>
                </div>

                <div class="bg-gray-900/50 p-4 border border-gray-800 rounded-md">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest">District Monitor</h4>
                        <button onclick="buyLand()" id="btn-buy-land"
                            class="text-[9px] bg-blue-900/20 border border-blue-800 px-2 py-0.5 rounded text-blue-400 hover:bg-blue-800/40 transition-all font-bold">EXPAND
                            (+100 Slots) $<span id="land-cost">10k</span></button>
                    </div>
                    <div id="city-visual-grid" class="flex flex-wrap gap-1 max-h-[160px] overflow-y-auto pr-1"></div>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="lg:col-span-8 space-y-6">
                <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                    <h3 class="text-lg font-bold flex items-center uppercase tracking-tighter">
                        <span class="mr-2 text-xl">‚ò¢Ô∏è</span> Reactor Command
                    </h3>
                    <button id="master-ovr-btn"
                        class="hidden master-ovr-btn px-4 py-1 text-[9px] font-bold border border-gray-600 bg-gray-800 text-gray-400 rounded hover:border-red-500 transition-all uppercase tracking-widest">
                        HOLD MASTER OVR
                    </button>
                </div>

                <div id="reactor-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Dynamic Units and Buy card appear here -->
                </div>

                <!-- UPGRADE TRAY -->
                <div id="upgrade-tray-container"
                    class="bg-gray-900/40 border border-gray-800 p-4 rounded-lg mt-8 shadow-inner">
                    <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center">
                        <span class="mr-2 text-blue-500">‚öôÔ∏è</span> STRATEGIC UPGRADES & MODIFIERS
                    </h4>
                    <div id="upgrade-tray" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Upgrades sorted: Available -> Expensive -> Installed -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- DEBUG CONSOLE -->
    <div id="debug-panel">
        <div class="max-w-6xl mx-auto flex gap-4 items-center flex-wrap">
            <span class="text-red-500 font-bold uppercase">Superintendent Access:</span>
            <button onclick="state.cash += 100000000; refreshStaticUI();"
                class="bg-gray-800 px-2 py-1 rounded border border-gray-600 hover:bg-gray-700">+$100M Cash</button>
            <button onclick="debugInstantResearch()"
                class="bg-gray-800 px-2 py-1 rounded border border-gray-600 hover:bg-gray-700">Max Research</button>
            <button onclick="state.reactors.forEach(r => r.heat = 0)"
                class="bg-gray-800 px-2 py-1 rounded border border-gray-600 hover:bg-gray-700">Reset Heat</button>
            <button id="btn-ff" onclick="debugToggleFF()"
                class="bg-gray-800 px-2 py-1 rounded border border-gray-600 hover:bg-gray-700">FF Toggle (OFF)</button>
            <button onclick="toggleDebug()"
                class="bg-red-900/40 px-2 py-1 rounded border border-red-500 text-red-500 ml-auto">CLOSE
                CONSOLE</button>
        </div>
    </div>

    <!-- CONTRACTS MODAL -->
    <div id="contracts-modal" class="modal-overlay">
        <div class="modal-box border-yellow-500 max-w-[800px] w-full">
            <span class="modal-close" onclick="toggleContractsModal()">[CLOSE]</span>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-yellow-500 uppercase tracking-widest">Available Contracts</h2>
                <div class="text-xs text-gray-400 font-bold uppercase tracking-widest">Corp Rep: <span
                        id="corp-rep-display" class="text-white">0</span></div>
            </div>

            <div id="contracts-list" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- Contract Cards -->
            </div>

            <p class="text-[10px] text-gray-500 text-center font-bold uppercase tracking-widest">Warning: Failure to
                meet contract terms may result in penalty.</p>
        </div>
    </div>

    <!-- ACTIVE CONTRACT HUD -->
    <div id="contract-hud"
        class="hidden fixed top-24 right-4 w-64 bg-gray-900/90 border border-yellow-500/50 p-4 rounded shadow-lg z-40">
        <div class="flex justify-between items-start mb-2">
            <h4 class="text-[10px] font-bold text-yellow-500 uppercase tracking-tighter">Active Contract</h4>
            <span id="contract-timer" class="text-sm font-bold text-white font-mono">00:00</span>
        </div>
        <div id="contract-title" class="text-xs font-bold text-white uppercase tracking-widest mb-3">Unknown</div>
        <div class="space-y-2">
            <div class="flex justify-between text-[10px] font-bold text-gray-400 uppercase">
                <span>Progress</span>
                <span id="contract-status-text">--/--</span>
            </div>
            <div class="w-full bg-gray-800 h-1.5 rounded-full overflow-hidden">
                <div id="contract-progress-bar" class="bg-yellow-500 h-full w-0 transition-all duration-300"></div>
            </div>
            <p id="contract-desc-hud" class="text-[9px] text-gray-500 leading-tight mt-1"></p>
        </div>
    </div>

    <!-- DATA MODAL -->
    <div id="data-modal" class="modal-overlay">
        <div class="modal-box border-blue-500">
            <span class="modal-close" onclick="toggleDataModal()">[CLOSE]</span>
            <h2 class="text-xl font-bold text-blue-400 mb-4 uppercase tracking-widest">Data Management</h2>

            <div class="space-y-4">
                <div>
                    <label class="text-xs uppercase font-bold text-gray-500">Export Save</label>
                    <button onclick="exportSave()"
                        class="w-full py-2 bg-blue-900/20 border border-blue-800 text-blue-400 text-xs font-bold uppercase hover:bg-blue-800/40 mt-1">Copy
                        Save String to Clipboard</button>
                </div>

                <div>
                    <label class="text-xs uppercase font-bold text-gray-500">Import Save</label>
                    <textarea id="import-area" class="save-string" placeholder="Paste save string here..."></textarea>
                    <button onclick="importSave()"
                        class="w-full py-2 bg-emerald-900/20 border border-emerald-800 text-emerald-400 text-xs font-bold uppercase hover:bg-emerald-800/40">Import
                        Data</button>
                </div>

                <div class="pt-4 border-t border-gray-800">
                    <button onclick="hardReset()"
                        class="w-full py-2 bg-red-900/20 border border-red-800 text-red-500 text-xs font-bold uppercase hover:bg-red-800/40">HARD
                        RESET (WIPE SAVE)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- OFFLINE MODAL -->
    <div id="offline-modal" class="modal-overlay">
        <div class="modal-box border-emerald-500">
            <h2 class="text-xl font-bold text-emerald-400 mb-2 uppercase tracking-widest">System Report</h2>
            <p class="text-xs text-gray-400 mb-6">Automated systems continued operation during absence.</p>

            <div class="bg-gray-900 p-4 rounded border border-gray-700 mb-6 text-center">
                <div class="text-[9px] uppercase text-gray-500 tracking-widest">Offline Revenue Generated</div>
                <div class="text-3xl font-bold text-emerald-400">$<span id="offline-cash">0</span></div>
                <div class="text-[9px] uppercase text-gray-600 mt-2 tracking-tighter">Efficiency Rating: 50%</div>
                <div class="text-[9px] uppercase text-gray-600 tracking-tighter">Duration: <span
                        id="offline-time">0s</span></div>
            </div>

            <button onclick="closeOfflineModal()"
                class="w-full py-3 bg-emerald-600 text-white font-bold uppercase tracking-widest hover:bg-emerald-500">Acknowledge
                & Resume</button>
        </div>
    </div>

    <div class="fixed bottom-4 right-4 z-[99] flex gap-2">
        <button onclick="toggleContractsModal()" id="btn-contracts-open"
            class="bg-yellow-900/20 border border-yellow-900 text-yellow-500 hover:bg-yellow-900/40 text-[8px] px-2 py-1 rounded uppercase tracking-widest font-bold">Contracts</button>
        <button onclick="toggleDataModal()"
            class="bg-blue-900/20 border border-blue-900 text-blue-400 hover:text-blue-300 hover:border-blue-500 text-[8px] px-2 py-1 rounded uppercase tracking-widest">Data
            / Save</button>
        <button onclick="toggleDebug()"
            class="bg-red-900/20 border border-red-900 text-red-900 hover:text-red-500 hover:border-red-500 text-[8px] px-2 py-1 rounded uppercase tracking-widest">Debug
            Access</button>
    </div>

    <template id="reactor-template">
        <div
            class="reactor-unit p-4 bg-gray-900/80 border border-gray-700 rounded-lg relative overflow-hidden transition-all reactor-card-fixed">
            <div class="flex justify-between mb-2">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-tighter">UNIT <span
                        class="u-id">X</span></span>
                <span
                    class="u-gen text-[9px] bg-gray-800 px-2 py-0.5 rounded text-gray-400 font-bold uppercase tracking-widest">GEN
                    II</span>
            </div>
            <div class="mb-4">
                <div class="flex justify-between text-[10px] font-bold mb-1">
                    <span>CORE TEMP: <span class="u-temp-val">0%</span></span>
                    <span class="text-emerald-400 tracking-tighter">STACKED MULT: <span
                            class="u-multiplier-val">1.0x</span></span>
                </div>
                <div class="heat-bar-bg rounded-sm">
                    <div class="heat-zone-marker" style="left: 25%;"></div>
                    <div class="heat-zone-marker" style="left: 50%;"></div>
                    <div class="heat-zone-marker" style="left: 75%;"></div>
                    <div class="heat-bar-fill w-0 zone-tier-1 u-heat-fill"></div>
                </div>
            </div>
            <div class="text-center space-y-3">
                <div class="flex justify-between text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1">
                    <span>Output: <span class="u-power">0</span> MW</span>
                    <span class="text-blue-400">Share: $<span class="u-rev">0</span>/s</span>
                </div>
                <button
                    class="u-overdrive-btn w-full py-4 bg-gray-800 border border-gray-600 text-[10px] font-bold tracking-tighter hover:bg-gray-700 active:bg-red-950 transition-colors uppercase">Hold
                    to Overdrive</button>
                <button
                    class="u-upgrade-btn w-full py-1 text-[9px] text-emerald-500 border border-emerald-900/50 rounded-sm hover:bg-emerald-900/30 transition-all uppercase disabled:opacity-30">Retrofit
                    Core ($<span class="u-upgrade-cost">5k</span>)</button>
            </div>
            <div
                class="u-scram-overlay hidden absolute inset-0 bg-red-950/60 flex flex-col items-center justify-center backdrop-blur-[2px] z-20 text-center">
                <span class="text-white font-bold text-xl tracking-tighter uppercase">Scram Active</span>
                <span class="text-[10px] text-red-200 mt-2 font-bold uppercase text-shadow-sm">Cooling Core...</span>
            </div>
        </div>
    </template>

    <template id="buy-unit-template">
        <div id="add-unit-card" onclick="addReactor()"
            class="p-4 border-2 border-dashed border-gray-700 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-emerald-500 group transition-all reactor-card-fixed">
            <span class="text-4xl text-gray-600 group-hover:text-emerald-500">+</span>
            <span class="text-xs text-gray-500 mt-2 font-bold uppercase tracking-widest">Commission Unit</span>
            <span class="text-[10px] text-emerald-600 font-bold" id="unit-cost-label-dynamic">$5,000</span>
        </div>
    </template>

    <script>
        const INITIAL_STATE = {
            cash: 150,
            lastSaveTime: Date.now(),
            managers: [],
            buildings: {
                house: { count: 0, baseCost: 100, demand: 1, revenue: 2 },
                factory: { count: 0, baseCost: 15000, demand: 25, revenue: 150 },
                datacenter: { count: 0, baseCost: 2000000, demand: 200, revenue: 2500 },
                skyscraper: { count: 0, baseCost: 50000000, demand: 1000, revenue: 25000 }
            },
            reactors: [{ id: 1, gen: 2, heat: 0, isOverdrive: false, isScrammed: false, upgradeCost: 5000, baseMW: 150 }],
            nextUnitCost: 5000,
            hasSync: false,
            hasFirefighters: false,
            hasSmartGrid: false,
            hasAI: false,
            hasLLM: false,
            hasMaintenance: false,
            maxGenUnlocked: 2,
            masterOverdriveActive: false,
            ffMultiplier: 1,
            lastTickCash: 0,
            debugOpen: false,
            districtSize: 100,
            landCost: 10000,
            market: {
                basePrice: 0.10,
                multiplier: 1.0,
                trend: [],
                phase: 0,
                state: 'STABLE', // STABLE, BULL, BEAR, HIGH_VOLATILITY
                news: "Market Stable. Grid demand normal.",
                timer: 0
            },
            contracts: { available: [], active: null, completed: 0, reputation: 0 }
        };

        const UPGRADES = [
            {
                id: 'arch',
                name: 'R&D Laboratory',
                getLabel: (s) => s.maxGenUnlocked < 4 ? ("Develop advanced core blueprints for GEN " + (s.maxGenUnlocked + 1) + " units. Massive increase to Power Capacity and base Revenue yield.") : (s.maxGenUnlocked === 4 ? "Research FUSION Architecture (GEN V). Capable of sustaining 1.5GW base load per core." : "Fusion Era Unlocked"),
                getCost: (s) => (s.maxGenUnlocked === 2 ? 250000 : (s.maxGenUnlocked === 3 ? 1250000 : 100000000)),
                isInstalled: (s) => s.maxGenUnlocked >= 5,
                canBuy: () => true,
                action: buyArchitecture
            },
            {
                id: 'sync',
                name: 'Synchronous Overdrive',
                getLabel: () => 'Unlocks Master Overdrive button which allows for control of all reactor units simultaneously.',
                getCost: () => 50000,
                isInstalled: (s) => s.hasSync,
                canBuy: () => true,
                action: () => { state.hasSync = true; }
            },
            {
                id: 'fire',
                name: 'Firefighters',
                getLabel: () => 'On site emergency services reduce SCRAM time by 20%, bringing crashed units back online significantly faster.',
                getCost: () => 75000,
                isInstalled: (s) => s.hasFirefighters,
                canBuy: () => true,
                action: () => { state.hasFirefighters = true; }
            },
            {
                id: 'grid',
                name: 'Smart Grid',
                getLabel: () => 'Install automated load-shedding hardware. Prevents city revenue from crashing during brownouts, maintaining a 90% income floor.',
                getCost: () => 500000,
                isInstalled: (s) => s.hasSmartGrid,
                canBuy: () => true,
                action: () => { state.hasSmartGrid = true; }
            },
            {
                id: 'ai',
                name: 'Artificial Intelligence',
                getLabel: () => 'Integrate neural networks. Data Centers produce 2x profit but use 3x more energy (600MW).',
                getCost: () => 1500000,
                isInstalled: (s) => s.hasAI,
                canBuy: () => true,
                action: () => { state.hasAI = true; }
            },
            {
                id: 'llm',
                name: 'Large Language Models (LLM)',
                getLabel: () => 'Efficiencies in AI usage reduces data center energy use to 2x (400MW). REQUIRES Artificial Intelligence.',
                getCost: () => 5000000,
                isInstalled: (s) => s.hasLLM,
                canBuy: (s) => s.hasAI,
                action: () => { state.hasLLM = true; }
            },
            {
                id: 'maintenance',
                name: 'Maintenance Crews',
                getLabel: () => 'Better maintenance crews allow for more efficient efficiency of reactor units. Grants +50% Max Output to all reactor cores.',
                getCost: () => 750000,
                isInstalled: (s) => s.hasMaintenance,
                canBuy: () => true,
                action: () => { state.hasMaintenance = true; }
            }
        ];

        const MANAGER_TYPES = {
            engineer: { name: "Engineer", bonus: "+15% Power", color: "emerald", desc: "Optimizes turbines to increase total MegaWatt capacity." },
            procurement: { name: "Procurement", bonus: "-10% Price", color: "blue", desc: "Negotiates bulk rates to reduce city construction costs." },
            safety: { name: "Safety", bonus: "-20% Heat", color: "red", desc: "Advanced liquid cooling slows core temperature rise." },
            tax: { name: "Tax Consultant", bonus: "+15% Revenue", color: "purple", desc: "Maximizes taxation revenue from all buildings on the grid." }
        };

        const GEN_STABILITY = { 2: 1.0, 3: 0.75, 4: 0.5, 5: 0.4 };
        const GEN_TIER_MULTIPLIERS = {
            2: [1.10, 1.30, 1.70, 2.00],
            3: [1.30, 1.60, 2.20, 2.80],
            4: [1.50, 2.00, 3.00, 4.00],
            5: [1.80, 2.50, 4.00, 6.00]
        };
        const GEN_BASE_GRANT = { 2: 5, 3: 50, 4: 250, 5: 2500 };

        let state = JSON.parse(JSON.stringify(INITIAL_STATE));
        let lastTick = Date.now();

        // SAVE SYSTEM
        function saveGame() {
            state.lastSaveTime = Date.now();
            localStorage.setItem('atomic-tycoon-save', JSON.stringify(state));
            console.log('Game Saved');
        }

        function loadGame() {
            const saved = localStorage.getItem('atomic-tycoon-save');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...INITIAL_STATE, ...parsed, buildings: { ...INITIAL_STATE.buildings, ...parsed.buildings } };
                    // Deep merge buildings to ensure new types exist
                    Object.keys(INITIAL_STATE.buildings).forEach(k => {
                        if (!state.buildings[k]) state.buildings[k] = INITIAL_STATE.buildings[k];
                    });
                    if (!state.market) state.market = { ...INITIAL_STATE.market };
                    // Recalculate managers/reactors if needed (validation)

                    // Validate Next Unit Cost for new scaling
                    const rCount = state.reactors.length;
                    if (rCount === 1) state.nextUnitCost = 5000;
                    else if (rCount === 2) state.nextUnitCost = 500000;
                    else if (rCount === 3) state.nextUnitCost = 50000000;

                    checkOfflineProgress();
                } catch (e) { console.error("Save Corrupt", e); }
            }
            refreshStaticUI(); renderReactors(); renderManagers();
        }

        function checkOfflineProgress() {
            const now = Date.now();
            const diff = now - state.lastSaveTime;
            if (diff > 60000) { // 1 minute minimum
                // Estimate earnings: (Current Revenue / s) * (diff / 1000) * 0.50
                // Note: We need to calculate revenue based on current structure count
                const pC = state.managers.filter(m => m.type === 'procurement').length; // Actually we need Eng/Tax bonuses
                // Let's run a quick sim

                const eC = state.managers.filter(m => m.type === 'engineer').length;
                const tC = state.managers.filter(m => m.type === 'tax').length;
                const pM = 1 + (eC * 0.15);
                const rM = 1 + (tC * 0.15);
                const maintM = state.hasMaintenance ? 1.5 : 1.0;

                const dcDemand = state.hasLLM ? 400 : (state.hasAI ? 600 : 200);
                const dcRevenue = state.hasAI ? 5000 : 2500;

                // Calc total power capacity (approximate avg heat 0)
                let totalCap = 0;
                state.reactors.forEach(r => {
                    const genMult = GEN_STABILITY[r.gen] || 1.0; // Wait, stability is for heat. We need output.
                    // output = base * 1 * pM. (Assumes no overdrive offline)
                    totalCap += r.baseMW * pM * maintM;
                });

                const demand = (state.buildings.house.count * 1) + (state.buildings.factory.count * 25) +
                    (state.buildings.datacenter.count * dcDemand) + (state.buildings.skyscraper.count * 1000);

                const isBrownout = totalCap < demand && demand > 0;
                const eff = isBrownout ? (state.hasSmartGrid ? 0.90 : 0.70) : 1.0;

                const cityBase = (state.buildings.house.count * 2) + (state.buildings.factory.count * 150) +
                    (state.buildings.datacenter.count * dcRevenue) + (state.buildings.skyscraper.count * 25000);

                const reactorUnitRev = state.reactors.reduce((acc, r) => acc + (GEN_BASE_GRANT[r.gen] || 5), 0);

                const surplus = Math.max(0, totalCap - demand);
                const exportInc = surplus * 0.10;

                const revPerSec = ((cityBase * eff) + reactorUnitRev) * rM + exportInc;

                const earned = revPerSec * (diff / 1000) * 0.50; // 50% penalty

                if (earned > 0) {
                    state.cash += earned;
                    document.getElementById('offline-cash').innerText = formatNum(earned);
                    document.getElementById('offline-time').innerText = formatTime(diff);
                    document.getElementById('offline-modal').classList.add('open');
                }
            }
        }

        function toggleDataModal() { document.getElementById('data-modal').classList.toggle('open'); }
        function closeOfflineModal() { document.getElementById('offline-modal').classList.remove('open'); }

        function exportSave() {
            const str = btoa(JSON.stringify(state));
            navigator.clipboard.writeText(str).then(() => alert("Save Copied to Clipboard!"));
        }

        function importSave() {
            const str = document.getElementById('import-area').value;
            try {
                const json = atob(str);
                const parsed = JSON.parse(json);
                state = parsed;
                document.getElementById('data-modal').classList.remove('open');
                saveGame();
                location.reload();
            } catch (e) { alert("Invalid Save String"); }
        }

        function hardReset() {
            if (confirm("Are you sure? This will wipe all progress.")) {
                window.onbeforeunload = null;
                localStorage.removeItem('atomic-tycoon-save');
                location.reload();
            }
        }

        function formatTime(ms) {
            const s = Math.floor(ms / 1000);
            if (s < 60) return s + 's';
            if (s < 3600) return Math.floor(s / 60) + 'm';
            return Math.floor(s / 3600) + 'h';
        }

        setInterval(saveGame, 30000); // Auto save 30s
        window.onbeforeunload = saveGame; // Save on exit

        function getHeatFillClass(heat) {
            if (heat >= 75) return 'zone-tier-4';
            if (heat >= 50) return 'zone-tier-3';
            if (heat >= 25) return 'zone-tier-2';
            if (heat >= 1) return 'zone-tier-1';
            return 'bg-gray-700';
        }

        function toggleDebug() {
            state.debugOpen = !state.debugOpen;
            const panel = document.getElementById('debug-panel');
            if (panel) panel.style.display = (state.debugOpen ? 'block' : 'none');
        }

        function debugInstantResearch() {
            state.maxGenUnlocked = 5; state.hasSync = true; state.hasFirefighters = true; state.hasSmartGrid = true; state.hasAI = true; state.hasLLM = true; refreshStaticUI(); renderReactors();
        }

        function debugToggleFF() {
            state.ffMultiplier = (state.ffMultiplier === 1 ? 5 : 1);
            const ffBtn = document.getElementById('btn-ff');
            if (ffBtn) ffBtn.innerText = "FF Toggle (" + state.ffMultiplier + "x)";
        }

        function buyLand() {
            if (state.cash >= state.landCost) {
                state.cash -= state.landCost;
                state.districtSize += 100;
                state.landCost *= 5;
                refreshStaticUI();
            }
        }

        function refreshStaticUI() {
            const pC = state.managers.filter(m => m.type === 'procurement').length;
            const discount = 1 - (pC * 0.10);

            ['house', 'factory', 'datacenter', 'skyscraper'].forEach(t => {
                const b = state.buildings[t];
                const countEl = document.getElementById('count-' + t);
                const costEl = document.getElementById('cost-' + t);
                if (countEl) countEl.innerText = b.count;
                if (costEl) costEl.innerText = formatNum(Math.floor(b.baseCost * Math.pow(1.2, b.count) * discount));
            });

            const dcTitle = document.getElementById('dc-title-label');
            if (dcTitle) dcTitle.innerText = (state.hasAI ? "AI DATA CENTER" : "DATA CENTER");
            const dcDemand = state.hasLLM ? 400 : (state.hasAI ? 600 : 200);
            const dcRevenue = state.hasAI ? 5000 : 2500;
            const demandLabel = document.getElementById('dc-demand-label');
            const revLabel = document.getElementById('dc-revenue-label');
            if (demandLabel) demandLabel.innerText = dcDemand;
            if (revLabel) revLabel.innerText = formatNum(dcRevenue);

            const hC = state.buildings.house.count, fC = state.buildings.factory.count, dC = state.buildings.datacenter.count;
            const fusUnlocked = state.maxGenUnlocked >= 5;

            const btnFactory = document.getElementById('btn-factory');
            if (btnFactory) btnFactory.classList.toggle('disabled-milestone', hC < 10);

            const btnDC = document.getElementById('btn-datacenter');
            if (btnDC) btnDC.classList.toggle('disabled-milestone', fC < 20);

            const btnSky = document.getElementById('btn-skyscraper');
            const skyIsLocked = dC < 10 || !fusUnlocked;
            if (btnSky) btnSky.classList.toggle('disabled-milestone', skyIsLocked);

            const skyDescEl = document.getElementById('skyscraper-desc');
            if (skyDescEl) {
                let skyDesc = "1k MW | $25k/s ‚Ä¢ " + state.buildings.skyscraper.count + " Units";
                if (dC < 10) skyDesc = "Unlock: 10 Data Centers";
                else if (!fusUnlocked) skyDesc = "Unlock: Research FUSION";
                skyDescEl.innerText = skyDesc;
            }

            const landCostEl = document.getElementById('land-cost');
            if (landCostEl) landCostEl.innerText = formatNum(state.landCost);

            const mBtn = document.getElementById('master-ovr-btn');
            if (state.hasSync && mBtn) { mBtn.classList.remove('hidden'); setupMasterHoldEvents(); }

            renderUpgradeTray();
            const dClabel = document.getElementById('unit-cost-label-dynamic');
            if (dClabel) dClabel.innerText = '$' + formatNum(state.nextUnitCost);
        }

        function renderUpgradeTray() {
            const tray = document.getElementById('upgrade-tray');
            if (!tray) return;

            let sorted = [...UPGRADES];
            sorted.sort((a, b) => {
                const installedA = a.isInstalled(state);
                const installedB = b.isInstalled(state);
                if (installedA !== installedB) return (installedA ? 1 : -1);
                const canBuyA = (a.canBuy(state) && state.cash >= a.getCost(state));
                const canBuyB = (b.canBuy(state) && state.cash >= b.getCost(state));
                if (canBuyA !== canBuyB) return (canBuyA ? -1 : 1);
                return (a.getCost(state) - b.getCost(state));
            });

            tray.innerHTML = '';
            sorted.forEach(u => {
                const isInstalled = u.isInstalled(state);
                const cost = u.getCost(state);
                const isAffordable = (state.cash >= cost);
                const canBuy = u.canBuy(state);

                const el = document.createElement('div');
                let statusClass = isInstalled ? 'installed' : ((isAffordable && canBuy) ? 'affordable' : 'locked');
                el.className = "upgrade-tray-item " + statusClass;
                el.dataset.id = u.id;

                if (!isInstalled) {
                    el.onclick = () => { if (state.cash >= cost && canBuy) { state.cash -= cost; u.action(); refreshStaticUI(); } };
                }

                const costFormatted = formatNum(cost);
                const nameDisplay = u.name + (isInstalled ? "" : " ($" + costFormatted + ")");
                const badgeHtml = isInstalled ? '<span class="installed-badge">System Active</span>' : '';
                const costStyle = (isAffordable && canBuy ? 'text-emerald-400' : 'text-rose-500');
                const costHtml = isInstalled ? "" : '<div class="upgrade-cost-text ' + costStyle + '">$' + costFormatted + '</div>';

                el.innerHTML = `
                    ${badgeHtml}
                    <div class="upgrade-title-text ${isInstalled ? 'text-blue-300' : 'text-gray-100'} uppercase">
                        ${nameDisplay}
                    </div>
                    <div class="upgrade-desc-text ${isInstalled ? 'text-blue-500' : 'text-gray-400'}">${u.getLabel(state)}</div>
                    ${costHtml}
                `;
                tray.appendChild(el);
            });
        }

        function setupMasterHoldEvents() {
            const btn = document.getElementById('master-ovr-btn');
            if (!btn || btn.dataset.setup) return;
            const startM = (e) => { e.preventDefault(); state.masterOverdriveActive = true; btn.classList.add('master-ovr-active'); btn.innerText = "LINKED REDLINE ACTIVE"; };
            const stopM = () => { state.masterOverdriveActive = false; btn.classList.remove('master-ovr-active'); btn.innerText = "Hold for Master Overdrive"; state.reactors.forEach(r => r.isOverdrive = false); };
            btn.onmousedown = startM; btn.onmouseup = stopM; btn.onmouseleave = stopM; btn.ontouchstart = startM; btn.ontouchend = stopM;
            btn.dataset.setup = "true";
        }

        function getManagerCost(count) {
            if (count === 0) return 1000;
            if (count === 1) return 25000;
            if (count === 2) return 1000000;
            if (count === 3) return 25000000;
            return 0; // Maxed
        }

        function addReactor() {
            if (state.reactors.length < 4 && state.cash >= state.nextUnitCost) {
                state.cash -= state.nextUnitCost;
                state.reactors.push({ id: state.reactors.length + 1, gen: 2, heat: 0, isOverdrive: false, isScrammed: false, baseMW: 150 });

                // New Cost Scaling: 5k -> 500k -> 50M
                if (state.reactors.length === 2) state.nextUnitCost = 500000;
                else if (state.reactors.length === 3) state.nextUnitCost = 50000000;

                renderReactors(); refreshStaticUI();
            }
        }

        function buyBuilding(type) {
            const b = state.buildings[type];
            const pC = state.managers.filter(m => m.type === 'procurement').length;
            const disc = 1 - (pC * 0.10);
            const cost = Math.floor(b.baseCost * Math.pow(1.2, b.count) * disc);
            if ((type === 'factory' && state.buildings.house.count < 10) ||
                (type === 'datacenter' && state.buildings.factory.count < 20) ||
                (type === 'skyscraper' && (state.buildings.datacenter.count < 10 || state.maxGenUnlocked < 5))) return;
            if (state.cash >= cost) { state.cash -= cost; b.count++; refreshStaticUI(); }
        }

        function hireManager() {
            const cost = getManagerCost(state.managers.length);
            if (state.managers.length >= 4 || state.cash < cost) return;
            state.cash -= cost;
            state.managers.push({ id: Date.now(), type: 'engineer' });
            renderManagers(); refreshStaticUI();
        }

        function buyArchitecture() { if (state.maxGenUnlocked < 5) { state.maxGenUnlocked++; renderReactors(); refreshStaticUI(); } }

        function updateManagerType(managerId, nT) {
            const m = state.managers.find(m => m.id === managerId);
            if (m) {
                m.type = nT;
                const idx = state.managers.indexOf(m);
                const bEl = document.getElementById('manager-bonus-' + idx);
                const tEl = document.getElementById('manager-tooltip-' + idx);
                if (bEl) bEl.innerText = MANAGER_TYPES[nT].bonus;
                if (tEl) tEl.innerText = MANAGER_TYPES[nT].desc;
                refreshStaticUI();
            }
        }

        function renderManagers() {
            const container = document.getElementById('manager-slots');
            if (!container) return;
            container.innerHTML = '';
            for (let i = 0; i < 4; i++) {
                const m = state.managers[i];
                const slot = document.createElement('div');
                slot.className = "border border-gray-700 bg-gray-900/80 rounded p-2 flex flex-col justify-between h-20 transition-all";
                if (m) {
                    const ct = MANAGER_TYPES[m.type];
                    slot.innerHTML = `
                        <div class="flex justify-between items-start">
                            <span class="text-[7px] font-bold text-gray-600 uppercase flex items-center">P-${i + 1} <div class="tooltip ml-1 cursor-help"><span class="text-[10px] text-gray-400 bg-gray-800 px-1 rounded-full border border-gray-700">?</span><span class="tooltiptext" id="manager-tooltip-${i}">${ct.desc}</span></div></span>
                            <span class="text-[7px] font-bold text-emerald-500 uppercase animate-pulse">Online</span>
                        </div>
                        <div class="my-1"><select class="manager-select" onchange="updateManagerType(${m.id}, this.value)">${Object.keys(MANAGER_TYPES).map(t => `<option value="${t}" ${t === m.type ? 'selected' : ''}>${MANAGER_TYPES[t].name}</option>`).join('')}</select></div>
                        <div id="manager-bonus-${i}" class="text-[6px] text-gray-500 leading-tight uppercase font-bold tracking-tighter">${ct.bonus}</div>
                    `;
                } else {
                    const cost = getManagerCost(state.managers.length);
                    slot.innerHTML = `<button onclick="hireManager()" id="hire-btn-${i}" class="w-full h-full flex flex-col items-center justify-center group transition-all"><span class="text-[9px] font-bold text-emerald-500 group-hover:text-emerald-400 uppercase">+ Hire</span><span class="text-[7px] text-gray-500 font-bold">$${formatNum(cost)}</span></button>`;
                    if (state.managers.length >= 4) slot.innerHTML = `<div class="w-full h-full flex items-center justify-center"><span class="text-[8px] text-gray-800 font-bold uppercase tracking-widest">Reserved</span></div>`;
                }
                container.appendChild(slot);
            }
            const managerCountEl = document.getElementById('manager-count');
            if (managerCountEl) managerCountEl.innerText = state.managers.length;
        }

        function addReactor() {
            if (state.reactors.length < 4 && state.cash >= state.nextUnitCost) {
                state.cash -= state.nextUnitCost;
                state.reactors.push({ id: state.reactors.length + 1, gen: 2, heat: 0, isOverdrive: false, isScrammed: false, baseMW: 150 });

                // New Cost Scaling: 5k -> 500k -> 50M
                if (state.reactors.length === 2) state.nextUnitCost = 500000;
                else if (state.reactors.length === 3) state.nextUnitCost = 50000000;

                renderReactors(); refreshStaticUI();
            }
        }

        function getUpgradeCost(gen) {
            if (gen >= 5) return 0;
            return 100000 * Math.pow(10, gen - 2);
        }

        function upgradeReactor(id) {
            const r = state.reactors.find(x => x.id === id);
            const cost = getUpgradeCost(r.gen);
            if (r && r.gen < state.maxGenUnlocked && state.cash >= cost) {
                state.cash -= cost;
                r.gen++;
                if (r.gen === 5) {
                    r.baseMW = 5000;
                } else {
                    r.baseMW *= 3.0;
                }
                // Cost is now dynamic, no need to update r.upgradeCost
                renderReactors(); refreshStaticUI();
            }
        }

        function renderReactors() {
            const grid = document.getElementById('reactor-grid');
            if (!grid) return;
            grid.innerHTML = '';
            state.reactors.forEach(r => {
                const clone = document.getElementById('reactor-template').content.cloneNode(true);
                const root = clone.querySelector('.reactor-unit');
                root.dataset.id = r.id;
                root.querySelector('.u-id').innerText = r.id;

                let genLabel = "GEN " + (r.gen === 2 ? "II" : r.gen === 3 ? "III" : r.gen === 4 ? "IV" : "V");
                if (r.gen === 5) {
                    genLabel = "FUSION";
                    root.querySelector('.u-gen').classList.add('text-cyan-400', 'border-cyan-900');
                }
                const cost = getUpgradeCost(r.gen);
                root.querySelector('.u-gen').innerText = genLabel;
                root.querySelector('.u-upgrade-cost').innerText = formatNum(cost);

                const upBtn = root.querySelector('.u-upgrade-btn');
                if (r.gen >= state.maxGenUnlocked) {
                    upBtn.innerText = (r.gen === 5 ? "STABLE EQUILIBRIUM" : "RESEARCH REQ.");
                    upBtn.disabled = true;
                }
                else upBtn.onclick = () => upgradeReactor(r.id);

                const ovrBtn = root.querySelector('.u-overdrive-btn');
                const startO = (e) => { e.preventDefault(); if (!state.masterOverdriveActive) r.isOverdrive = true; };
                const stopO = () => { if (!state.masterOverdriveActive) r.isOverdrive = false; };
                ovrBtn.onmousedown = startO; ovrBtn.onmouseup = stopO; ovrBtn.onmouseleave = stopO; ovrBtn.ontouchstart = startO; ovrBtn.ontouchend = stopO;
                grid.appendChild(clone);
            });
            if (state.reactors.length < 4) { grid.appendChild(document.getElementById('buy-unit-template').content.cloneNode(true)); }
        }

        function formatNum(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return Math.floor(num);
        }

        function renderMarketSparkline() {
            const el = document.getElementById('market-sparkline');
            if (!el) return;
            el.innerHTML = '';
            // Render last 30 points
            // Trend is variable length, take last 24
            const data = state.market.trend.slice(-24);
            if (data.length === 0) return;

            const min = 0.5; // Fixed scale for stability
            const max = 2.0;

            data.forEach(val => {
                const bar = document.createElement('div');
                // Normalize height 0-100%
                let h = ((val - min) / (max - min)) * 100;
                if (h < 5) h = 5; if (h > 100) h = 100;

                bar.style.height = h + '%';
                bar.className = "w-1 " + (val >= 1.0 ? "bg-emerald-500" : "bg-red-500");
                el.appendChild(bar);
            });
        }

        // CONTRACTS SYSTEM
        const CONTRACT_TYPES = [
            {
                id: 'surge',
                title: 'Surge Test',
                desc: 'Maintain Heat > 50% on all units.',
                duration: 30,
                difficulty: 'med',
                rewardScale: 300, // Multiplier of base rev
                check: (s) => s.reactors.every(r => r.heat >= 50 && !r.isScrammed),
                fail: (s) => s.reactors.some(r => r.isScrammed)
            },
            {
                id: 'stability',
                title: 'Stability Audit',
                desc: 'No Brownouts permitted.',
                duration: 60,
                difficulty: 'easy',
                rewardScale: 100,
                check: (s) => {
                    const dcDemand = s.hasLLM ? 400 : (s.hasAI ? 600 : 200);
                    const demand = (s.buildings.house.count * 1) + (s.buildings.factory.count * 25) + (s.buildings.datacenter.count * dcDemand) + (s.buildings.skyscraper.count * 1000);
                    // Calc power
                    const eC = s.managers.filter(m => m.type === 'engineer').length;
                    const pM = 1 + (eC * 0.25);
                    const maintM = s.hasMaintenance ? 1.5 : 1.0;
                    let cap = 0;
                    s.reactors.forEach(r => { if (!r.isScrammed) cap += r.baseMW * (r.isOverdrive ? 2.5 : 1) * pM * maintM; });
                    return cap >= demand; // Pass if cap meets demand
                },
                fail: (s) => {
                    // Keep Logic simple: if check returns false, we fail immediately? 
                    // No, "check" is for "is condition currently met".
                    // For stability, condition IS met if no brownout.
                    // Failure is if Brownout occurs. So actually, check() should return true if safe.
                    // If check() returns false, that's a fail.
                    return false;
                }
            },
            {
                id: 'export',
                title: 'Export Rush',
                desc: 'Export > 50% of Total Gen.',
                duration: 45,
                difficulty: 'hard',
                rewardScale: 500,
                check: (s) => {
                    const dcDemand = s.hasLLM ? 400 : (s.hasAI ? 600 : 200);
                    const demand = (s.buildings.house.count * 1) + (s.buildings.factory.count * 25) + (s.buildings.datacenter.count * dcDemand) + (s.buildings.skyscraper.count * 1000);
                    const eC = s.managers.filter(m => m.type === 'engineer').length;
                    const pM = 1 + (eC * 0.25);
                    const maintM = s.hasMaintenance ? 1.5 : 1.0;
                    let cap = 0;
                    s.reactors.forEach(r => { if (!r.isScrammed) cap += r.baseMW * (r.isOverdrive ? 2.5 : 1) * pM * maintM; });
                    if (cap === 0) return false;
                    return (cap - demand) > (cap * 0.5);
                },
                fail: (s) => false // No fail condition other than time running out?
            }
        ];

        function generateContracts() {
            state.contracts.available = [];
            for (let i = 0; i < 3; i++) {
                const type = CONTRACT_TYPES[Math.floor(Math.random() * CONTRACT_TYPES.length)];
                // Create instance
                const baseReward = Math.max(10000, state.income * type.rewardScale); // Scale with income
                state.contracts.available.push({
                    uid: Date.now() + i,
                    typeId: type.id,
                    title: type.title,
                    desc: type.desc,
                    duration: type.duration,
                    difficulty: type.difficulty,
                    reward: Math.floor(baseReward),
                    tier: i // 0, 1, 2
                });
            }
            renderContractsModal();
        }

        function toggleContractsModal() {
            const m = document.getElementById('contracts-modal');
            if (!m.classList.contains('open')) {
                // If opening and empty, gen
                if (state.contracts.available.length === 0) generateContracts();
                renderContractsModal();
            }
            m.classList.toggle('open');
        }

        function renderContractsModal() {
            const list = document.getElementById('contracts-list');
            const rep = document.getElementById('corp-rep-display');
            if (rep) rep.innerText = state.contracts.reputation;
            if (!list) return;

            list.innerHTML = '';
            state.contracts.available.forEach(c => {
                const el = document.createElement('div');
                const diffColor = c.difficulty === 'easy' ? 'text-emerald-400' : (c.difficulty === 'med' ? 'text-yellow-400' : 'text-red-500');
                const borderClass = 'contract-d-' + c.difficulty;

                el.className = "contract-card " + borderClass;
                el.onclick = () => acceptContract(c.uid);
                el.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[9px] font-bold uppercase tracking-widest ${diffColor}">[${c.difficulty.toUpperCase()}]</span>
                            <span class="text-[9px] font-bold text-gray-500">${c.duration}s</span>
                        </div>
                        <h3 class="text-sm font-bold text-gray-200 uppercase mb-1">${c.title}</h3>
                        <p class="text-[10px] text-gray-400 leading-tight">${c.desc}</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between items-end">
                        <div class="text-[8px] uppercase text-gray-500 font-bold">Payout</div>
                        <div class="text-lg font-bold text-emerald-400">$${formatNum(c.reward)}</div>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function acceptContract(uid) {
            const c = state.contracts.available.find(x => x.uid === uid);
            if (c) {
                state.contracts.active = {
                    ...c,
                    timeLeft: c.duration,
                    progress: 0
                };
                // Clear available so valid only once
                state.contracts.available = [];
                toggleContractsModal();
                updateContractHUD();
            }
        }

        function updateContractHUD() {
            const hud = document.getElementById('contract-hud');
            const c = state.contracts.active;
            if (!c) {
                hud.classList.add('hidden');
                return;
            }
            hud.classList.remove('hidden');

            document.getElementById('contract-title').innerText = c.title;
            document.getElementById('contract-timer').innerText = c.timeLeft.toFixed(1) + 's';
            // Status update handled in loop
            document.getElementById('contract-desc-hud').innerText = c.desc;
        }

        function spawnFloatingText(x, y, text, colorClass) {
            const el = document.createElement('div');
            el.className = `floating-text ${colorClass} text-2xl`;
            el.innerText = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }

        function completeContract(success) {
            const c = state.contracts.active;
            state.contracts.active = null;
            updateContractHUD();

            const cashEl = document.getElementById('cash-display');
            const rect = cashEl ? cashEl.getBoundingClientRect() : { left: window.innerWidth / 2, top: window.innerHeight / 2 };

            if (success) {
                state.cash += c.reward;
                state.contracts.completed++;
                state.contracts.reputation += (c.difficulty === 'hard' ? 5 : 1);

                spawnFloatingText(rect.left + 20, rect.top, "+$" + formatNum(c.reward), "text-emerald-400");
                spawnFloatingText(rect.left + 20, rect.top + 30, "CONTRACT COMPLETE", "text-yellow-400 text-sm");
            } else {
                spawnFloatingText(rect.left, rect.top, "CONTRACT FAILED", "text-red-500");
            }
            refreshStaticUI();
        }

        function gameLoop() {
            const now = Date.now();
            const dt = ((now - lastTick) / 1000) * state.ffMultiplier;
            lastTick = now;

            // Initialize Contracts State if missing
            if (!state.contracts) state.contracts = { available: [], active: null, completed: 0, reputation: 0 };
            // Calc income for ref
            state.income = state.lastIncome || 100; // rough hack for gen

            // CONTRACT LOGIC
            if (state.contracts.active) {
                const c = state.contracts.active;
                const def = CONTRACT_TYPES.find(x => x.id === c.typeId);
                const passed = def.check(state);

                // Handling specific fail conditions
                // Stability: fail if !passed (if brownout)
                // Others: Just don't progress if !passed?

                // Logic refinement:
                // Surge: Must maintain. If you dip, maybe just pause progress? Or fail? The desc says "Maintain".
                // Let's implement strict "Fail if condition broken" for Stability
                // For Surge/Export, we track "Time Valid". 
                // WAIT. "Maintained for duration". 
                // Simple Mechanic: Timer decreases. If condition is met, great. If condition NOT met at end? Or must be met continuously?
                // "Maintain per s" usually means "Accumulate Y seconds of good time" OR "Don't fail for Y seconds".
                // Let's go with: Timer ticks down. If condition met, good. If condition NOT met, we might fail instantly (Stability) or just not count?
                // Let's try: You must survive the duration. If you fail the check, instant Fail (for Stability/Surge).
                // Actually Surge is hard to perfect. Let's make it: "Accumulate X seconds of coverage"?
                // Re-reading proposal: "Maintain ... for 30s".

                // Implementation:
                // Timer always ticks down.
                // Status is checked.
                // If Stability && !passed -> Fail.
                // If Surge && !passed -> Fail (Strict).
                // If Export && !passed -> Fail (Strict).
                // This makes them Hard. Good.

                if (c.typeId === 'stability') {
                    if (!passed) { completeContract(false); return; } // Brownout = Fail
                } else {
                    // For Surge/Export, if you dip below, fail?
                    // Let's be slightly lenient for tick alignment, but strict is better game design.
                    if (!passed) c.failTimer = (c.failTimer || 0) + dt;
                    else c.failTimer = 0;

                    if (c.failTimer > 2.0) { // Allow 2s grace? No, stricter.
                        // completeContract(false); return; 
                    }
                    // Actually, let's make it Progress Bar based.
                    // You need to FILL the bar to win? No, duration is fixed.
                    // Okay, let's keep it simple: Timer counts down. You must meet condition when it hits 0?
                    // No, "Maintain for 30s" implies continuous.

                    // Revised Logic:
                    // Timer counts down.
                    // If condition !passed, Timer PAUSES? No.
                    // If condition !passed, FAIL.
                }

                // Actually, let's simplify check logic to:
                // Status text shows "OK" or "WARNING".
                // If Condition met: Timer ticks down.
                // If Condition NOT met: Timer pauses (and maybe red flashes).
                // If you don't finish in (Duration * 2) real time, you fail?
                // Let's stick to: Condition must be met to progress.
                // We track "TimeSatisfied". Goal is Duration.
                // We also track "TimeElapsed". If TimeElapsed > Duration * 1.5, Fail.

                if (!c.timeSatisfied) c.timeSatisfied = 0;

                if (passed) {
                    c.timeSatisfied += dt;
                    document.getElementById('contract-status-text').innerHTML = '<span class="text-emerald-500">CONDITION MET</span>';
                    document.getElementById('contract-progress-bar').className = 'bg-emerald-500 h-full transition-all duration-300';
                } else {
                    document.getElementById('contract-status-text').innerHTML = '<span class="text-red-500">CONDITION FAILED</span>';
                    document.getElementById('contract-progress-bar').className = 'bg-red-500 h-full transition-all duration-300';
                    // Specific instant fails
                    if (c.typeId === 'stability') { completeContract(false); return requestAnimationFrame(gameLoop); }
                }

                // Visual progress
                const pct = (c.timeSatisfied / c.duration) * 100;
                document.getElementById('contract-progress-bar').style.width = pct + '%';
                document.getElementById('contract-timer').innerText = (c.duration - c.timeSatisfied).toFixed(1) + 's';

                if (c.timeSatisfied >= c.duration) {
                    completeContract(true);
                    return requestAnimationFrame(gameLoop);
                }
            }

            // MARKET LOGIC
            // Ensure state exists if hot-loaded
            if (!state.market) state.market = { basePrice: 0.10, multiplier: 1.0, trend: [], phase: 0, state: 'STABLE', news: 'Market Stable.', timer: 0 };

            // Market Event System
            if (!state.market.timer) state.market.timer = 0;
            state.market.timer -= dt;
            if (state.market.timer <= 0) {
                // Pick new state
                const r = Math.random();
                let duration = 30 + Math.random() * 60; // 30s - 90s

                if (r < 0.6) {
                    state.market.state = 'STABLE';
                    state.market.news = "Market Stable. Grid demand normal.";
                } else if (r < 0.75) {
                    state.market.state = 'BULL';
                    state.market.news = "NEWS: Heatwave predicted! Grid demand SURGING.";
                    duration = 45;
                } else if (r < 0.90) {
                    state.market.state = 'BEAR';
                    state.market.news = "NEWS: Mild weather across region. Consumption LOW.";
                    duration = 45;
                } else {
                    state.market.state = 'HIGH_VOLATILITY';
                    state.market.news = "NEWS: Grid instability detected. Prices ERRATIC.";
                    duration = 20;
                }
                state.market.timer = duration;
            }

            // Apply Multiplier based on State
            state.market.phase += dt * 0.5;
            let target = 1.0;

            if (state.market.state === 'STABLE') {
                target = 1.0 + Math.sin(state.market.phase) * 0.2; // 0.8 - 1.2
            } else if (state.market.state === 'BULL') {
                target = 1.8 + Math.sin(state.market.phase * 2) * 0.4; // 1.4 - 2.2
            } else if (state.market.state === 'BEAR') {
                target = 0.4 + Math.sin(state.market.phase * 0.5) * 0.1; // 0.3 - 0.5
            } else if (state.market.state === 'HIGH_VOLATILITY') {
                state.market.phase += dt * 4; // Fast flux
                target = 1.0 + Math.sin(state.market.phase) * 1.5; // 0.1 - 2.5 WILD
            }

            // Smooth lerp
            state.market.multiplier += (target - state.market.multiplier) * dt * (state.market.state === 'HIGH_VOLATILITY' ? 2.0 : 0.5);

            // Clamp hard limits
            if (state.market.multiplier < 0.05) state.market.multiplier = 0.05;
            if (state.market.multiplier > 3.0) state.market.multiplier = 3.0;

            // Trend History (every 1s approx)
            if (!state.market.lastTrendUpdate) state.market.lastTrendUpdate = 0;
            if (now - state.market.lastTrendUpdate > 1000) {
                state.market.trend.push(state.market.multiplier);
                if (state.market.trend.length > 24) state.market.trend.shift();
                state.market.lastTrendUpdate = now;
                renderMarketSparkline();
            }

            let powerAvail = 0, unitRevTotal = 0;
            const eC = state.managers.filter(m => m.type === 'engineer').length, sC = state.managers.filter(m => m.type === 'safety').length, tC = state.managers.filter(m => m.type === 'tax').length;
            const pM = 1 + (eC * 0.25), hM = 1 - (sC * 0.30), rM = 1 + (tC * 0.25);
            const maintM = state.hasMaintenance ? 1.5 : 1.0;

            if (state.masterOverdriveActive) state.reactors.forEach(r => { if (!r.isScrammed) r.isOverdrive = true; });

            let cascade = false;
            state.reactors.forEach(r => {
                const ui = document.querySelector('.reactor-unit[data-id="' + r.id + '"]');
                if (!ui) return;
                const stab = GEN_STABILITY[r.gen] || 1.0;
                if (r.isScrammed) {
                    const rR = state.hasFirefighters ? 15 : 12;
                    r.heat -= dt * rR; if (r.heat <= 0) { r.heat = 0; r.isScrammed = false; }
                    ui.classList.add('scram-active');
                } else {
                    ui.classList.remove('scram-active');
                    if (r.isOverdrive) {
                        r.heat += dt * 16 * (1 + (r.heat / 40)) * hM * stab;
                        if (r.heat >= 100) { r.heat = 100; r.isScrammed = true; r.isOverdrive = false; if (state.masterOverdriveActive) cascade = true; }
                    } else r.heat = Math.max(0, r.heat - dt * 5);
                    ui.classList.toggle('shake-light', r.heat > 50 && r.heat <= 75); ui.classList.toggle('shake-heavy', r.heat > 75);
                }
                const m = r.isOverdrive ? 2.5 : 1, o = (r.isScrammed ? 0 : r.baseMW * m) * pM * maintM;
                powerAvail += o;
                const tierIdx = (r.heat < 25 ? 0 : r.heat < 50 ? 1 : r.heat < 75 ? 2 : 3);
                const zm = r.isScrammed ? 0 : (r.heat < 1 ? 1 : GEN_TIER_MULTIPLIERS[r.gen][tierIdx]);
                const unitRev = (GEN_BASE_GRANT[r.gen] || 5) * zm;
                unitRevTotal += unitRev;
                ui.querySelector('.u-temp-val').innerText = Math.floor(r.heat) + '%'; ui.querySelector('.u-multiplier-val').innerText = zm.toFixed(2) + 'x';
                const f = ui.querySelector('.u-heat-fill'); f.style.width = r.heat + '%';
                f.className = 'heat-bar-fill u-heat-fill ' + getHeatFillClass(r.heat);
                ui.querySelector('.u-power').innerText = Math.floor(o); ui.querySelector('.u-rev').innerText = formatNum(unitRev);
                ui.querySelector('.u-scram-overlay').classList.toggle('hidden', !r.isScrammed);
            });

            if (cascade) {
                state.masterOverdriveActive = false; const mB = document.getElementById('master-ovr-btn');
                if (mB) { mB.classList.remove('master-ovr-active'); mB.innerText = "Hold for Master Overdrive"; }
                state.reactors.forEach(r => { r.isScrammed = true; r.isOverdrive = false; r.heat = 100; });
            }

            const dcDemand = state.hasLLM ? 400 : (state.hasAI ? 600 : 200);
            const dcRevenue = state.hasAI ? 5000 : 2500;
            const demand = (state.buildings.house.count * 1) + (state.buildings.factory.count * 25) + (state.buildings.datacenter.count * dcDemand) + (state.buildings.skyscraper.count * 1000);
            const isBrownout = powerAvail < demand && demand > 0, eff = isBrownout ? (state.hasSmartGrid ? 0.90 : 0.70) : 1.00;

            let wm = 0;
            if (powerAvail > 0) state.reactors.forEach(r => {
                if (!r.isScrammed) {
                    const s = (r.baseMW * (r.isOverdrive ? 2.5 : 1) * pM * maintM) / powerAvail;
                    const tierIdx = (r.heat < 25 ? 0 : r.heat < 50 ? 1 : r.heat < 75 ? 2 : 3);
                    wm += (r.heat < 1 ? 1 : GEN_TIER_MULTIPLIERS[r.gen][tierIdx]) * s;
                }
            });

            const cityBase = (state.buildings.house.count * 2) + (state.buildings.factory.count * 150) + (state.buildings.datacenter.count * dcRevenue) + (state.buildings.skyscraper.count * 25000);
            const surplus = Math.max(0, powerAvail - demand);
            const currentPrice = state.market.basePrice * state.market.multiplier;
            const exportInc = surplus * currentPrice;
            const finalInc = (cityBase * eff * wm * rM) + (unitRevTotal * rM) + exportInc;
            state.cash += (finalInc * dt);

            const cashDisplay = document.getElementById('cash-display');
            const incomeDisplay = document.getElementById('income-display');
            const exportDisplay = document.getElementById('export-display');
            const powerTotal = document.getElementById('power-total');
            const powerUsed = document.getElementById('power-used');
            if (cashDisplay) cashDisplay.innerText = formatNum(state.cash);
            if (incomeDisplay) incomeDisplay.innerText = formatNum(finalInc);
            if (exportDisplay) {
                exportDisplay.innerText = formatNum(exportInc);
                // Color code export based on market status (High = Green, Low = Red)
                exportDisplay.className = (state.market.multiplier > 1.2 ? "text-emerald-400" : (state.market.multiplier < 0.8 ? "text-red-400" : "text-orange-400"));
            }
            if (powerTotal) powerTotal.innerText = Math.floor(powerAvail);
            if (powerUsed) powerUsed.innerText = Math.floor(demand);

            // Update Header Ticker
            const priceEl = document.getElementById('market-price');
            const arrowEl = document.getElementById('market-trend-arrow');
            if (priceEl) {
                priceEl.innerText = '$' + currentPrice.toFixed(2);
                priceEl.className = "font-bold " + (state.market.multiplier > 1.0 ? "text-emerald-400" : "text-red-400");
            }
            if (arrowEl) {
                const prev = state.market.trend[state.market.trend.length - 2] || 1.0;
                const isUp = state.market.multiplier > prev;
                arrowEl.innerHTML = isUp ? "‚ñ≤" : "‚ñº";
                arrowEl.className = "text-xl font-bold " + (isUp ? "text-emerald-500" : "text-red-500");
            }

            const newsEl = document.getElementById('market-news');
            if (newsEl && state.market.news) {
                newsEl.innerText = state.market.news;
                // Color based on state
                newsEl.className = "text-[8px] font-bold uppercase tracking-widest inline-block animate-marquee pl-48 " +
                    (state.market.state === 'BULL' ? "text-emerald-400" :
                        state.market.state === 'BEAR' ? "text-red-400" :
                            state.market.state === 'HIGH_VOLATILITY' ? "text-orange-400" : "text-gray-500");
            }

            const effTag = document.getElementById('efficiency-tag');
            if (effTag) {
                effTag.innerText = "Efficiency: " + Math.round(eff * 100) + "%";
                effTag.className = "text-[9px] font-bold px-2 py-0.5 rounded-full inline-block mt-1 " + (isBrownout ? 'text-red-500 bg-red-950/30' : 'text-emerald-500 bg-emerald-950/30');
            }

            const sI = document.getElementById('stability-indicator');
            if (sI) {
                sI.innerText = (isBrownout ? "BROWNOUT DETECTED" : "Grid Stable");
                sI.className = "text-[10px] uppercase font-bold tracking-widest " + (isBrownout ? 'text-red-500 animate-pulse' : 'text-emerald-500');
            }

            if (Math.abs(state.cash - state.lastTickCash) > (state.cash * 0.05) || state.cash < 500) {
                renderUpgradeTray();
                state.lastTickCash = state.cash;
            }

            const trayItems = document.querySelectorAll('.upgrade-tray-item');
            trayItems.forEach(el => {
                const u = UPGRADES.find(x => x.id === el.dataset.id);
                if (u && !u.isInstalled(state)) {
                    const isAff = (state.cash >= u.getCost(state));
                    const canB = u.canBuy(state);
                    el.classList.toggle('affordable', isAff && canB);
                    el.classList.toggle('locked', !isAff || !canB);
                }
            });

            const gridDiv = document.getElementById('city-visual-grid');
            if (gridDiv) {
                const totalD = state.buildings.house.count + state.buildings.factory.count + state.buildings.datacenter.count + state.buildings.skyscraper.count;
                if (gridDiv.children.length !== Math.min(state.districtSize, totalD)) {
                    gridDiv.innerHTML = '';
                    let d = 0;
                    const types = [
                        { c: state.buildings.skyscraper.count, cl: 'bg-cyan-400 shadow-[0_0_8px_cyan]' },
                        { c: state.buildings.datacenter.count, cl: 'bg-purple-500 shadow-[0_0_5px_purple]' },
                        { c: state.buildings.factory.count, cl: 'bg-blue-500 shadow-[0_0_5px_blue]' },
                        { c: state.buildings.house.count, cl: 'bg-emerald-500 shadow-[0_0_5px_emerald]' }
                    ];
                    types.forEach(type => { for (let i = 0; i < type.c && d < state.districtSize; i++) { const el = document.createElement('div'); el.className = "city-grid-item " + type.cl; gridDiv.appendChild(el); d++; } });
                }
                gridDiv.querySelectorAll('.city-grid-item').forEach(item => item.classList.toggle('city-grid-dim', isBrownout));
                gridDiv.classList.toggle('brownout-flicker', isBrownout);
            }

            const btnBuyLand = document.getElementById('btn-buy-land');
            if (btnBuyLand) btnBuyLand.classList.toggle('not-affordable', state.cash < state.landCost);

            requestAnimationFrame(gameLoop);
        }

        loadGame(); // Load on startup
        renderReactors(); renderManagers(); refreshStaticUI(); requestAnimationFrame(gameLoop);
    </script>
</body>

</html>